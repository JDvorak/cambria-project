<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Cambria, Week Two: Prototyping the Solution | Cambria Development Notes</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.73.0" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/cambria/dist/css/app.4fc0b62e4b82c997bb0041217cd6b979.css" rel="stylesheet">
    

    <link href="/cambria/article.css"/>

    
      <link rel="stylesheet" href="/cambria/article.css">
    

    
      

    

    
    
    <meta property="og:title" content="Cambria, Week Two: Prototyping the Solution" />
<meta property="og:description" content="Last week we showed you a demo of a problem. We wanted to run two different versions of a program, both operating on different data types&hellip; but with the same underlying document.
This is a tricky problem! The old code doesn&rsquo;t natively understand data written by the new system. The new system relies on data the old one doesn&rsquo;t provide. Worst, even in our little toy example there is one field where the data type changes completely, going from a Boolean type to a string." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://inkandswitch.github.io/cambria/weekly-updates/week-2/" />
<meta property="article:published_time" content="2020-06-22T16:47:58-07:00" />
<meta property="article:modified_time" content="2020-06-22T16:47:58-07:00" />
<meta itemprop="name" content="Cambria, Week Two: Prototyping the Solution">
<meta itemprop="description" content="Last week we showed you a demo of a problem. We wanted to run two different versions of a program, both operating on different data types&hellip; but with the same underlying document.
This is a tricky problem! The old code doesn&rsquo;t natively understand data written by the new system. The new system relies on data the old one doesn&rsquo;t provide. Worst, even in our little toy example there is one field where the data type changes completely, going from a Boolean type to a string.">
<meta itemprop="datePublished" content="2020-06-22T16:47:58-07:00" />
<meta itemprop="dateModified" content="2020-06-22T16:47:58-07:00" />
<meta itemprop="wordCount" content="839">



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Cambria, Week Two: Prototyping the Solution"/>
<meta name="twitter:description" content="Last week we showed you a demo of a problem. We wanted to run two different versions of a program, both operating on different data types&hellip; but with the same underlying document.
This is a tricky problem! The old code doesn&rsquo;t natively understand data written by the new system. The new system relies on data the old one doesn&rsquo;t provide. Worst, even in our little toy example there is one field where the data type changes completely, going from a Boolean type to a string."/>

	
  </head>

  <body class="ma0 bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/cambria/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        Cambria Development Notes
      
    </a>
    <div class="flex-l items-center">
      

      
      















    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        WEEKLY-UPDATES
      </aside>
      




  <div id="sharing" class="mt3">

    
    <a href="https://www.facebook.com/sharer.php?u=http://inkandswitch.github.io/cambria/weekly-updates/week-2/" class="facebook no-underline" aria-label="share on Facebook">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765,50.32h6.744V33.998h4.499l0.596-5.624h-5.095  l0.007-2.816c0-1.466,0.14-2.253,2.244-2.253h2.812V17.68h-4.5c-5.405,0-7.307,2.729-7.307,7.317v3.377h-3.369v5.625h3.369V50.32z   M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>

    </a>

    
    
    <a href="https://twitter.com/share?url=http://inkandswitch.github.io/cambria/weekly-updates/week-2/&amp;text=Cambria,%20Week%20Two:%20Prototyping%20the%20Solution" class="twitter no-underline" aria-label="share on Twitter">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

    </a>

    
    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http://inkandswitch.github.io/cambria/weekly-updates/week-2/&amp;title=Cambria,%20Week%20Two:%20Prototyping%20the%20Solution" class="linkedin no-underline" aria-label="share on LinkedIn">
      <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

    </a>
  </div>


      <h1 class="f1 mt3 mb1">Cambria, Week Two: Prototyping the Solution</h1>
      
      
      <time class="f6 mv4 dib tracked" datetime="2020-06-22T16:47:58-07:00">June 22, 2020</time>

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p><!-- raw HTML omitted --> Last week we showed you a demo of a problem. We wanted to run two different versions of a program, both operating on different data types&hellip; but with the same underlying document.</p>
<p>This is a tricky problem! The old code doesn&rsquo;t natively understand data written by the new system. The new system relies on data the old one doesn&rsquo;t provide. Worst, even in our little toy example there is one field where the data type changes completely, going from a Boolean type to a string.</p>
<p>So, if last week was a prototype of a problem then this week is a prototype of a solution.</p>
<h1 id="a-prototype-of-a-solution">A prototype of a solution</h1>
<p><a href="../week-1">Last week&rsquo;s</a> <a href="https://www.loom.com/share/9887a085895a4ce4a39f6e70ef90cb0b">demo</a> showed data flowing back and forth between two systems. The implementation was a
giant soup of spaghetti code under the hood. This week we wanted to attempt a principled approach
to implementing that code automatically, and to also think a bit about developer experience.</p>
<p>What we&rsquo;ve got is a small library that can output JSON Schemas (to validate data), Typescript types,
and a big JSON file that describes all the rules to convert data between types.</p>
<p>The results is that when you&rsquo;re programming you have nice Typescript types to keep track of what
you&rsquo;re doing, and at runtime the system can handle all the conversions for you.</p>
<h1 id="migrations-sounds-like-database-code">Migrations? Sounds like database code.</h1>
<p>The big difference between our system and a traditional migration is that all of the versions exist
simultaneously in a super-imposed state in the underlying document. At read time we pull out the bits
of the underlying document that the running program needs and ignore the rest. When we write changes
we carefully map them down into the document again to ensure that old versions of the code will still
work, even if their documents have been edited by newer code.</p>
<p>Here&rsquo;s how it looks to write one of those migrations. In this example we&rsquo;ve decided that the status
of an issue is no longer either complete or not, but can now be a string with several values, like
&ldquo;in progress&rdquo;.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">runMigration</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;../chitin/migrationRunner&#39;</span>
<span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">convertField</span>, <span style="color:#a6e22e">valueMapping</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;../chitin/migrations&#39;</span>

<span style="color:#a6e22e">runMigration</span>((<span style="color:#a6e22e">graph</span>) =&gt; {
  <span style="color:#a6e22e">graph</span>.<span style="color:#a6e22e">extendSchema</span>(<span style="color:#e6db74">&#39;ProjectV3&#39;</span>, <span style="color:#e6db74">&#39;ProjectV4&#39;</span>, [
    <span style="color:#a6e22e">convertField</span>({
      <span style="color:#a6e22e">from</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;complete&#39;</span>, <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;boolean&#39;</span> },
      <span style="color:#a6e22e">to</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;status&#39;</span>, <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;string&#39;</span> },
      <span style="color:#a6e22e">forwards</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">valueMapping</span>({ <span style="color:#66d9ef">false</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;todo&#39;</span>, <span style="color:#66d9ef">true</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;done&#39;</span> }),
      <span style="color:#a6e22e">backwards</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">valueMapping</span>({ <span style="color:#a6e22e">todo</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span>, <span style="color:#a6e22e">inProgress</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span>, <span style="color:#a6e22e">done</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span> }),
    }),
  ])
})
</code></pre></div><p>You can see here that we&rsquo;re defining a new version of the Project data type (V4), and describing how
to map one field (and its data) back and forth between the two versions. This creates a link between
those types that the system can traverse.</p>
<h1 id="what-if-you-want-to-convert-data-between-systems">What if you want to convert data between systems?</h1>
<p>We&rsquo;ve also thought about that! In the case of an incremental change in a data format the above example
is convenient. You take the old format, make some changes, and that&rsquo;s the new format.</p>
<p>In our Arthropod test program we have a second, much simpler display for our Project data used in
the title bar. That display just shows the title and the description, so we gave it a similar data format
(HasTitle). In order to render the Project document there we need to define a conversion for that, too.</p>
<p>That looks like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">runMigration</span>((<span style="color:#a6e22e">graph</span>) =&gt; {
  <span style="color:#a6e22e">graph</span>.<span style="color:#a6e22e">connectSchemas</span>(<span style="color:#e6db74">&#39;ProjectV2&#39;</span>, <span style="color:#e6db74">&#39;HasTitleV1&#39;</span>, [
    <span style="color:#a6e22e">renameField</span>(<span style="color:#e6db74">&#39;name&#39;</span>, <span style="color:#e6db74">&#39;title&#39;</span>),
    <span style="color:#a6e22e">renameField</span>(<span style="color:#e6db74">&#39;description&#39;</span>, <span style="color:#e6db74">&#39;subtitle&#39;</span>),
    <span style="color:#a6e22e">removeField</span>(<span style="color:#e6db74">&#39;tasks&#39;</span>),
  ])
})
</code></pre></div><p>In this case we&rsquo;re not defining a new schema (ProjectV4), we&rsquo;re just saying how to connect two existing
ones.</p>
<h1 id="wait-a-second-youre-connecting-an-older-version-to-the-title-thing">Wait a second, you&rsquo;re connecting an older version to the Title thing!</h1>
<p>Astute of you to observe that, but it still works! Because we can map from HasTitleV1 to ProjectV2
and then on up from there through ProjectV3 and ProjectV4 the system finds a path and moves the data
back and forth seamlessly. As long as there is a path, the system will find it! Even an old ProjectV1
file could follow this path.</p>
<h1 id="whats-next">What&rsquo;s next?</h1>
<p>Well, our more principled implementation has better &ldquo;bones&rdquo;, but it&rsquo;s still missing some important pieces.
First, it doesn&rsquo;t handle nested data very well yet. If you want to rename a field and it&rsquo;s not connected
to the root of the document? Too bad. Orion&rsquo;s working on that this week.</p>
<p>Next, our canonical representation has become increasingly difficult to reason about. We suspect that
we can separate the conversion logic from the underlying storage layout, which will hopefully both 
simplify each piece of the system and also make them more independently useful. Geoffrey is working 
on exploring that.</p>
<p>Last, we&rsquo;ve had a number of fascinating discussions about what the correct behavior <em>should</em> be for 
some of these cases. If you check and uncheck the <code>complete</code> Boolean, what should happen to the 
<code>status</code> string?</p>
<p>Along with concrete progress in improving the capabilities of the system we also want to document our
expectations for how various cases will behave in a test suite. Peter&rsquo;s planning to focus on that to
the extent that pandemic parenting allows.</p>
<p>No demo video this week. Maybe next week? We&rsquo;ll see.</p>
<ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://inkandswitch.github.io/cambria/" >
    &copy;  Cambria Development Notes 2020 
  </a>
    <div>














</div>
  </div>
</footer>

    

  <script src="/cambria/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
